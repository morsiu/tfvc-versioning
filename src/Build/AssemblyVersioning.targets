<?xml version="1.0" encoding="utf-8"?>
<Project 
  ToolsVersion="15.0"
  DefaultTargets="GenerateCompileItemWithAssemblyVersionAttributes"
  xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="TfsVersion.targets"/>
  <ItemGroup>
    <VersionFile Include="Version.g.txt"/>
    <AssemblyInfoFile Include="AssemblyInfo.g.cs"/>
  </ItemGroup>
  <Target Name="GetTfsTopChangesetId">
    <TfsVersion
      BaseUrl="https://morsiu.visualstudio.com/"
      PersonalAccessToken="$(TfsVersionPersonalAccessToken)"
      Project="TfvcTest2"
      ItemPath="$/TfvcTest2/BuildProcessTemplates">
      <Output TaskParameter="TopChangesetId" PropertyName="TopChangesetId" />
    </TfsVersion>
  </Target>
  <Target 
    Name="WriteTopChangesetIdToVersionItems"
    DependsOnTargets="GetTfsTopChangesetId"
    Outputs="@(VersionFile)">
    <ItemGroup>
      <VersionLine Include="$(TopChangesetId)"/>
    </ItemGroup>
    <WriteLinesToFile
      File="@(VersionFile)"
      Encoding="UTF-8"
      Overwrite="True"
      WriteOnlyWhenDifferent="True"
      Lines="@(VersionFileLine)" />
  </Target>
  <Target
    Name="GenerateCompileItemWithAssemblyVersionAttributes"
    DependsOnTargets="WriteTopChangesetIdToVersionItems"
    Inputs="@(VersionFile)"
    Outputs="@(AssemblyInfoFile)">
    <ItemGroup>
      <Compile Include="@(AssemblyInfoFile)" />
    </ItemGroup>
    <ItemGroup>
      <ReadLinesFromFile
        File="@(VersionFile)"
        Lines="@(VersionFileLine)" />
      <AssemblyVersionAttributes Include="AssemblyVersion">
        <_Parameter1>1.0.0.@(VersionFileLine)</_Parameter1>
      </AssemblyVersionAttributes>
      <AssemblyAttributes Include="AssemblyFileVersion">
        <_Parameter1>1.0.0.@(VersionFileLine)</_Parameter1>
      </AssemblyAttributes>
    </ItemGroup>
    <WriteCodeFragment
      Language="C#"
      OutputFile="@(AssemblyInfoFile)"
      AssemblyAttributes="@(AssemblyVersionAttributes)" />
  </Target>
</Project>